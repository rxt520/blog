(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{344:function(e,s,a){"use strict";a.r(s);var t=a(3),r=Object(t.a)({},(function(){var e=this,s=e.$createElement,a=e._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"docker-compose-模板文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-模板文件"}},[e._v("#")]),e._v(" Docker Compose 模板文件")]),e._v(" "),a("h2",{attrs:{id:"模板文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模板文件"}},[e._v("#")]),e._v(" 模板文件")]),e._v(" "),a("p",[e._v("模板文件是使用 Compose 的核心，涉及到的指令关键字也比较多。但大家不用担心，这里面大部分指令跟 "),a("code",[e._v("docker run")]),e._v(" 相关参数的含义都是类似的。")]),e._v(" "),a("p",[e._v("默认的模板文件名称为 "),a("code",[e._v("docker-compose.yml")]),e._v("，格式为 YAML 格式。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('version: "3"services:  webapp:    image: examples/web    ports:      - "80:80"    volumes:      - "/data"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("注意每个服务都必须通过 "),a("code",[e._v("image")]),e._v(" 指令指定镜像或 "),a("code",[e._v("build")]),e._v(" 指令（需要 Dockerfile）等来自动构建生成镜像。")]),e._v(" "),a("p",[e._v("如果使用 "),a("code",[e._v("build")]),e._v(" 指令，在 "),a("code",[e._v("Dockerfile")]),e._v(" 中设置的选项(例如："),a("code",[e._v("CMD")]),e._v(", "),a("code",[e._v("EXPOSE")]),e._v(", "),a("code",[e._v("VOLUME")]),e._v(", "),a("code",[e._v("ENV")]),e._v(" 等) 将会自动被获取，无需在 "),a("code",[e._v("docker-compose.yml")]),e._v(" 中再次设置。")]),e._v(" "),a("p",[e._v("下面分别介绍各个指令的用法。")]),e._v(" "),a("h2",{attrs:{id:"build"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#build"}},[e._v("#")]),e._v(" build")]),e._v(" "),a("p",[e._v("指定 "),a("code",[e._v("Dockerfile")]),e._v(" 所在文件夹的路径（可以是绝对路径，或者相对 docker-compose.yml 文件的路径）。 "),a("code",[e._v("Compose")]),e._v(" 将会利用它自动构建这个镜像，然后使用这个镜像。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("version: '3'services:  webapp:    build: ./dir\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("你也可以使用 "),a("code",[e._v("context")]),e._v(" 指令指定 "),a("code",[e._v("Dockerfile")]),e._v(" 所在文件夹的路径。使用 "),a("code",[e._v("dockerfile")]),e._v(" 指令指定 "),a("code",[e._v("Dockerfile")]),e._v(" 文件名。使用 "),a("code",[e._v("arg")]),e._v(" 指令指定构建镜像时的变量。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("version: '3'services:  webapp:    build:      context: ./dir      dockerfile: Dockerfile-alternate      args:        buildno: 1\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("使用 "),a("code",[e._v("cache_from")]),e._v(" 指定构建镜像的缓存")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("build:  context: .  cache_from:    - alpine:latest    - corp/web_app:3.14\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"cap-add-cap-drop"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cap-add-cap-drop"}},[e._v("#")]),e._v(" cap_add, cap_drop")]),e._v(" "),a("p",[e._v("指定容器的内核能力（capacity）分配。例如，让容器拥有所有能力可以指定为：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("cap_add:  - ALL\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("去掉 NET_ADMIN 能力可以指定为：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("cap_drop:  - NET_ADMIN\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"command"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#command"}},[e._v("#")]),e._v(" command")]),e._v(" "),a("p",[e._v("覆盖容器启动后默认执行的命令。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('command: echo "hello world"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"configs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configs"}},[e._v("#")]),e._v(" configs")]),e._v(" "),a("p",[e._v("仅用于 "),a("code",[e._v("Swarm mode")])]),e._v(" "),a("h2",{attrs:{id:"cgroup-parent"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cgroup-parent"}},[e._v("#")]),e._v(" cgroup_parent")]),e._v(" "),a("p",[e._v("指定父 "),a("code",[e._v("cgroup")]),e._v(" 组，意味着将继承该组的资源限制。例如，创建了一个 cgroup 组名称为 "),a("code",[e._v("cgroups_1")]),e._v("。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("cgroup_parent: cgroups_1\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"container-name"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#container-name"}},[e._v("#")]),e._v(" container_name")]),e._v(" "),a("p",[e._v("指定容器名称。默认将会使用 "),a("code",[e._v("项目名称_服务名称_序号")]),e._v(" 这样的格式。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("container_name: docker-web-container\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("blockquote",[a("p",[a("strong",[e._v("注意:")]),e._v(" 指定容器名称后，该服务将无法进行扩展（scale），因为 Docker 不允许多个容器具有相同的名称。")])]),e._v(" "),a("h2",{attrs:{id:"deploy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deploy"}},[e._v("#")]),e._v(" deploy")]),e._v(" "),a("p",[e._v("仅用于 "),a("code",[e._v("Swarm mode")])]),e._v(" "),a("h2",{attrs:{id:"devices"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#devices"}},[e._v("#")]),e._v(" devices")]),e._v(" "),a("p",[e._v("指定设备映射关系。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('devices:  - "/dev/ttyUSB1:/dev/ttyUSB0"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"depends-on"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#depends-on"}},[e._v("#")]),e._v(" depends_on")]),e._v(" "),a("p",[e._v("解决容器的依赖、启动先后的问题。以下例子中会先启动 "),a("code",[e._v("redis")]),e._v(" "),a("code",[e._v("db")]),e._v(" 再启动 "),a("code",[e._v("web")])]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("version: '3'services:  web:    build: .    depends_on:      - db      - redis  redis:    image: redis  db:    image: postgres\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("blockquote",[a("p",[a("strong",[e._v("注意：")]),e._v(" "),a("code",[e._v("web")]),e._v(" 服务不会等待 "),a("code",[e._v("redis")]),e._v(" "),a("code",[e._v("db")]),e._v(" 「完全启动」之后才启动。")])]),e._v(" "),a("h2",{attrs:{id:"dns"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dns"}},[e._v("#")]),e._v(" dns")]),e._v(" "),a("p",[e._v("自定义 "),a("code",[e._v("DNS")]),e._v(" 服务器。可以是一个值，也可以是一个列表。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("dns: 8.8.8.8dns:  - 8.8.8.8  - 114.114.114.114\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"dns-search"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dns-search"}},[e._v("#")]),e._v(" dns_search")]),e._v(" "),a("p",[e._v("配置 "),a("code",[e._v("DNS")]),e._v(" 搜索域。可以是一个值，也可以是一个列表。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("dns_search: example.comdns_search:  - domain1.example.com  - domain2.example.com\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"tmpfs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tmpfs"}},[e._v("#")]),e._v(" tmpfs")]),e._v(" "),a("p",[e._v("挂载一个 tmpfs 文件系统到容器。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("tmpfs: /runtmpfs:  - /run  - /tmp\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"env-file"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#env-file"}},[e._v("#")]),e._v(" env_file")]),e._v(" "),a("p",[e._v("从文件中获取环境变量，可以为单独的文件路径或列表。如果通过 "),a("code",[e._v("docker-compose -f FILE")]),e._v(" 方式来指定 Compose 模板文件，则 "),a("code",[e._v("env_file")]),e._v(" 中变量的路径会基于模板文件路径。如果有变量名称与 "),a("code",[e._v("environment")]),e._v(" 指令冲突，则按照惯例，以后者为准。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("env_file: .envenv_file:  - ./common.env  - ./apps/web.env  - /opt/secrets.env\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("环境变量文件中每一行必须符合格式，支持 "),a("code",[e._v("#")]),e._v(" 开头的注释行。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("# common.env: Set development environmentPROG_ENV=development\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"environment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#environment"}},[e._v("#")]),e._v(" environment")]),e._v(" "),a("p",[e._v("设置环境变量。你可以使用数组或字典两种格式。")]),e._v(" "),a("p",[e._v("只给定名称的变量会自动获取运行 Compose 主机上对应变量的值，可以用来防止泄露不必要的数据。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("environment:  RACK_ENV: development  SESSION_SECRET:environment:  - RACK_ENV=development  - SESSION_SECRET\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("如果变量名称或者值中用到 "),a("code",[e._v("true|false，yes|no")]),e._v(" 等表达 "),a("a",{attrs:{href:"http://www.qfdmy.com/wp-content/themes/quanbaike/go.php?url=aHR0cDovL3lhbWwub3JnL3R5cGUvYm9vbC5odG1s",target:"_blank",rel:"noopener noreferrer"}},[e._v("布尔"),a("OutboundLink")],1),e._v(" 含义的词汇，最好放到引号里，避免 YAML 自动解析某些内容为对应的布尔语义。这些特定词汇，包括")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("y|Y|yes|Yes|YES|n|N|no|No|NO|true|True|TRUE|false|False|FALSE|on|On|ON|off|Off|OFF\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"expose"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#expose"}},[e._v("#")]),e._v(" expose")]),e._v(" "),a("p",[e._v("暴露端口，但不映射到宿主机，只被连接的服务访问。仅可以指定内部端口为参数")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('expose: - "3000" - "8000"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"external-links"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#external-links"}},[e._v("#")]),e._v(" external_links")]),e._v(" "),a("blockquote",[a("p",[a("strong",[e._v("注意：")]),e._v(" 不建议使用该指令。")])]),e._v(" "),a("p",[e._v("链接到 "),a("code",[e._v("docker-compose.yml")]),e._v(" 外部的容器，甚至并非 "),a("code",[e._v("Compose")]),e._v(" 管理的外部容器。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("external_links: - redis_1 - project_db_1:mysql - project_db_1:postgresql\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"extra-hosts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#extra-hosts"}},[e._v("#")]),e._v(" extra_hosts")]),e._v(" "),a("p",[e._v("类似 Docker 中的 "),a("code",[e._v("--add-host")]),e._v(" 参数，指定额外的 host 名称映射信息。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('extra_hosts: - "googledns:8.8.8.8" - "dockerhub:52.1.157.61"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("会在启动后的服务容器中 "),a("code",[e._v("/etc/hosts")]),e._v(" 文件中添加如下两条条目。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("8.8.8.8 googledns52.1.157.61 dockerhub\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"healthcheck"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#healthcheck"}},[e._v("#")]),e._v(" healthcheck")]),e._v(" "),a("p",[e._v("通过命令检查容器是否健康运行。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('healthcheck:  test: ["CMD", "curl", "-f", "http://localhost"]  interval: 1m30s  timeout: 10s  retries: 3\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"image"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#image"}},[e._v("#")]),e._v(" image")]),e._v(" "),a("p",[e._v("指定为镜像名称或镜像 ID。如果镜像在本地不存在，"),a("code",[e._v("Compose")]),e._v(" 将会尝试拉取这个镜像。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("image: ubuntuimage: orchardup/postgresqlimage: a4bc65fd\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"labels"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#labels"}},[e._v("#")]),e._v(" labels")]),e._v(" "),a("p",[e._v("为容器添加 Docker 元数据（metadata）信息。例如可以为容器添加辅助说明信息。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('labels:  com.startupteam.description: "webapp for a startup team"  com.startupteam.department: "devops department"  com.startupteam.release: "rc3 for v1.0"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"links"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#links"}},[e._v("#")]),e._v(" links")]),e._v(" "),a("blockquote",[a("p",[e._v("注意：不推荐使用该指令。")])]),e._v(" "),a("h2",{attrs:{id:"logging"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#logging"}},[e._v("#")]),e._v(" logging")]),e._v(" "),a("p",[e._v("配置日志选项。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('logging:  driver: syslog  options:    syslog-address: "tcp://192.168.0.42:123"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("目前支持三种日志驱动类型。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('driver: "json-file"driver: "syslog"driver: "none"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[a("code",[e._v("options")]),e._v(" 配置日志驱动的相关参数。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('options:  max-size: "200k"  max-file: "10"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"network-mode"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#network-mode"}},[e._v("#")]),e._v(" network_mode")]),e._v(" "),a("p",[e._v("设置网络模式。使用和 "),a("code",[e._v("docker run")]),e._v(" 的 "),a("code",[e._v("--network")]),e._v(" 参数一样的值。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('network_mode: "bridge"network_mode: "host"network_mode: "none"network_mode: "service:[service name]"network_mode: "container:[container name/id]"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"networks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#networks"}},[e._v("#")]),e._v(" networks")]),e._v(" "),a("p",[e._v("配置容器连接的网络。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('version: "3"services:  some-service:    networks:     - some-network     - other-networknetworks:  some-network:  other-network:\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"pid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pid"}},[e._v("#")]),e._v(" pid")]),e._v(" "),a("p",[e._v("跟主机系统共享进程命名空间。打开该选项的容器之间，以及容器和宿主机系统之间可以通过进程 ID 来相互访问和操作。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('pid: "host"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"ports"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ports"}},[e._v("#")]),e._v(" ports")]),e._v(" "),a("p",[e._v("暴露端口信息。")]),e._v(" "),a("p",[e._v("使用宿主端口：容器端口 "),a("code",[e._v("(HOST:CONTAINER)")]),e._v(" 格式，或者仅仅指定容器的端口（宿主将会随机选择端口）都可以。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('ports: - "3000" - "8000:8000" - "49100:22" - "127.0.0.1:8001:8001"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("blockquote",[a("p",[a("strong",[e._v("注意：")]),e._v(" 当使用 "),a("code",[e._v("HOST:CONTAINER")]),e._v(" 格式来映射端口时，如果你使用的容器端口小于 60 并且没放到引号里，可能会得到错误结果，因为 "),a("code",[e._v("YAML")]),e._v(" 会自动解析 "),a("code",[e._v("xx:yy")]),e._v(" 这种数字格式为 60 进制。为避免出现这种问题，建议数字串都采用引号包括起来的字符串格式。")])]),e._v(" "),a("h2",{attrs:{id:"secrets"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#secrets"}},[e._v("#")]),e._v(" secrets")]),e._v(" "),a("p",[e._v("存储敏感数据，例如 "),a("code",[e._v("mysql")]),e._v(" 服务密码。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('version: "3.1"services:mysql:  image: mysql  environment:    MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password  secrets:    - db_root_password    - my_other_secretsecrets:  my_secret:    file: ./my_secret.txt  my_other_secret:    external: true\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"security-opt"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#security-opt"}},[e._v("#")]),e._v(" security_opt")]),e._v(" "),a("p",[e._v("指定容器模板标签（label）机制的默认属性（用户、角色、类型、级别等）。例如配置标签的用户名和角色名。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("security_opt:    - label:user:USER    - label:role:ROLE\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"stop-signal"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#stop-signal"}},[e._v("#")]),e._v(" stop_signal")]),e._v(" "),a("p",[e._v("设置另一个信号来停止容器。在默认情况下使用的是 SIGTERM 停止容器。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("stop_signal: SIGUSR1\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"sysctls"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sysctls"}},[e._v("#")]),e._v(" sysctls")]),e._v(" "),a("p",[e._v("配置容器内核参数。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sysctls:  net.core.somaxconn: 1024  net.ipv4.tcp_syncookies: 0sysctls:  - net.core.somaxconn=1024  - net.ipv4.tcp_syncookies=0\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"ulimits"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ulimits"}},[e._v("#")]),e._v(" ulimits")]),e._v(" "),a("p",[e._v("指定容器的 ulimits 限制值。")]),e._v(" "),a("p",[e._v("例如，指定最大进程数为 65535，指定文件句柄数为 20000（软限制，应用可以随时修改，不能超过硬限制） 和 40000（系统硬限制，只能 root 用户提高）。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("  ulimits:    nproc: 65535    nofile:      soft: 20000      hard: 40000\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"volumes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#volumes"}},[e._v("#")]),e._v(" volumes")]),e._v(" "),a("p",[e._v("数据卷所挂载路径设置。可以设置宿主机路径 （"),a("code",[e._v("HOST:CONTAINER")]),e._v("） 或加上访问模式 （"),a("code",[e._v("HOST:CONTAINER:ro")]),e._v("）。")]),e._v(" "),a("p",[e._v("该指令中路径支持相对路径。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("volumes: - /var/lib/mysql - cache/:/tmp/cache - ~/configs:/etc/configs/:ro\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"其它指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其它指令"}},[e._v("#")]),e._v(" 其它指令")]),e._v(" "),a("p",[e._v("此外，还有包括 "),a("code",[e._v("domainname, entrypoint, hostname, ipc, mac_address, privileged, read_only, shm_size, restart, stdin_open, tty, user, working_dir")]),e._v("等指令，基本跟 "),a("code",[e._v("docker run")]),e._v(" 中对应参数的功能一致。")]),e._v(" "),a("p",[e._v("指定服务容器启动后执行的入口文件。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("entrypoint: /code/entrypoint.sh\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("指定容器中运行应用的用户名。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("user: nginx\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("指定容器中工作目录。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("working_dir: /code\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("指定容器中搜索域名、主机名、mac 地址等。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("domainname: your_website.comhostname: testmac_address: 08-00-27-00-0C-0A\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("允许容器中运行一些特权命令。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("privileged: true\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("指定容器退出后的重启策略为始终重启。该命令对保持服务始终运行十分有效，在生产环境中推荐配置为 "),a("code",[e._v("always")]),e._v(" 或者 "),a("code",[e._v("unless-stopped")]),e._v("。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("restart: always\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("以只读模式挂载容器的 root 文件系统，意味着不能对容器内容进行修改。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("read_only: true\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("打开标准输入，可以接受外部输入。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("stdin_open: true\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("模拟一个伪终端。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("tty: true\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"读取变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#读取变量"}},[e._v("#")]),e._v(" 读取变量")]),e._v(" "),a("p",[e._v("Compose 模板文件支持动态读取主机的系统环境变量和当前目录下的 "),a("code",[e._v(".env")]),e._v(" 文件中的变量。")]),e._v(" "),a("p",[e._v("例如，下面的 Compose 文件将从运行它的环境中读取变量 "),a("code",[e._v("${MONGO_VERSION}")]),e._v(" 的值，并写入执行的指令中。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('version: "3"services:db:  image: "mongo:${MONGO_VERSION}"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("如果执行 "),a("code",[e._v("MONGO_VERSION=3.2 docker-compose up")]),e._v(" 则会启动一个 "),a("code",[e._v("mongo:3.2")]),e._v(" 镜像的容器；如果执行 "),a("code",[e._v("MONGO_VERSION=2.8 docker-compose up")]),e._v(" 则会启动一个 "),a("code",[e._v("mongo:2.8")]),e._v(" 镜像的容器。若当前目录存在 "),a("code",[e._v(".env")]),e._v(" 文件，执行 "),a("code",[e._v("docker-compose")]),e._v(" 命令时将从该文件中读取变量。在当前目录新建 "),a("code",[e._v(".env")]),e._v(" 文件并写入以下内容。")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("# 支持 # 号注释MONGO_VERSION=3.6\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("执行 "),a("code",[e._v("docker-compose up")]),e._v(" 则会启动一个 "),a("code",[e._v("mongo:3.6")]),e._v(" 镜像的容器。")])])}),[],!1,null,null,null);s.default=r.exports}}]);